<div class="vehicule-list-wrapper">
<div class="table-container">
  <!-- üîç Filtres -->
  <div class="filters">
    <mat-form-field class="search-field" appearance="fill">
      <mat-label>Recherche</mat-label>
      <input
        matInput
        type="text"
        [(ngModel)]="searchQuery"
        (input)="filtrerVehicules()"
        placeholder="Rechercher par N¬∞ Ch√¢ssis, modele , marque ou date de production"
      />
    </mat-form-field>

    <div class="filters-right">
      <mat-form-field appearance="fill">
        <mat-label>Parc</mat-label>
        <mat-select [(ngModel)]="selectedParcs" multiple (selectionChange)="filtrerVehicules()">
          <mat-option *ngFor="let parc of parcsAccessibles" [value]="parc.nom">
            {{ parc.nom }}
          </mat-option>       
         </mat-select>
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Marque</mat-label>
        <mat-select [(ngModel)]="selectedMarques" multiple (selectionChange)="filtrerVehicules()">
          <mat-option *ngFor="let marque of marquesDisponibles" [value]="marque">
            {{ marque }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Statut</mat-label>
        <mat-select [(ngModel)]="selectedStatut" (selectionChange)="filtrerVehicules()">
          <mat-option value="all">Tous</mat-option>
          <mat-option value="EN_ETAT">En Etat</mat-option>
          <mat-option value="AVARIE">Avari√©</mat-option>
          <mat-option value="RESERVE">Reserv√©</mat-option>
          <mat-option value="VENDU">Vendu</mat-option>
          <mat-option value="LIVRE">Livr√©</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- üß∞ Actions -->
  <div class="action-buttons">
    <button
      *ngIf="selectedParc === 'transit'"
      mat-raised-button
      color="primary"
      (click)="receptionnerTransfert(selection.selected[0]?.id)"
      [disabled]="selection.selected.length !== 1 || selection.selected[0]?.statut !== 'TRANSFERT'"
    >
      ‚úÖ R√©ceptionner
    </button>

    <button
      mat-raised-button
      color="accent"
      (click)="naviguerVersTransfert()"
      [disabled]="isTransfertDisabled() || !isOrdreMission"
      >
      Cr√©er ordre mission
    </button>
  </div>

  <!-- üìÑ Pagination -->
  <div class="pagination-container">
    <mat-paginator
      [pageSize]="10"
      [pageSizeOptions]="[10, 20, 50]"
      showFirstLastButtons
    ></mat-paginator>
  </div>

  <!-- üìã Tableau des v√©hicules -->
  <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" style="width: 100%;">
    <!-- ‚úÖ S√©lection -->
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef>
        <mat-checkbox (change)="toggleAllRows()" [checked]="isAllSelected()"></mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let vehicule">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="mettreAJourVehiculesSelectionnes(); selection.toggle(vehicule)"
          [checked]="selection.isSelected(vehicule)"
        ></mat-checkbox>
      </td>
    </ng-container>

    <!-- ‚úÖ Colonnes principales -->
    <ng-container matColumnDef="shortDescription">
      <th mat-header-cell *matHeaderCellDef>Marque</th>
      <td mat-cell *matCellDef="let vehicule">{{ vehicule.shortDescription || 'Non d√©fini' }}</td>
    </ng-container>
    <ng-container matColumnDef="modele">
      <th mat-header-cell *matHeaderCellDef>Mod√®le</th>
      <td mat-cell *matCellDef="let vehicule">{{ vehicule.modele }}</td>
    </ng-container>
    <ng-container matColumnDef="shortColor">
      <th mat-header-cell *matHeaderCellDef>Couleur</th>
      <td mat-cell *matCellDef="let vehicule">{{ vehicule.shortColor || 'Non d√©fini' }}</td>
    </ng-container>
    <ng-container matColumnDef="numeroChassis">
      <th mat-header-cell *matHeaderCellDef>N¬∞ Ch√¢ssis</th>
      <td mat-cell *matCellDef="let vehicule">{{ vehicule.numeroChassis }}</td>
    </ng-container>
    <ng-container matColumnDef="productionDate">
      <th mat-header-cell *matHeaderCellDef>Date de production</th>
      <td mat-cell *matCellDef="let vehicule">{{ vehicule.productionDate | date:'dd/MM/yyyy' }}</td>
    </ng-container>


    <ng-container matColumnDef="statut">
      <th mat-header-cell *matHeaderCellDef>Statut</th>
      <td mat-cell *matCellDef="let vehicule">
        <span class="status" [ngClass]="vehicule.statut?.toLowerCase()">
          {{ vehicule.statut || 'Non d√©fini' }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="parcNom">
      <th mat-header-cell *matHeaderCellDef>Parc</th>
      <td mat-cell *matCellDef="let vehicule">{{ vehicule.parcNom }}</td>
    </ng-container>

    <!-- ‚úÖ Actions -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="mat-column-actions">Actions</th>
      <td mat-cell *matCellDef="let vehicule" class="mat-column-actions">
        <button mat-icon-button [matMenuTriggerFor]="menu">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="ouvrirPopup(vehicule)">
            <mat-icon>visibility</mat-icon> Visualiser
          </button>
          <button mat-menu-item (click)="ouvrirPopupLivraison(vehicule)">
            <mat-icon>local_shipping</mat-icon> Livraison
          </button>
          <button mat-menu-item (click)="ouvrirPopupVente(vehicule)">
            <mat-icon>shopping_cart</mat-icon> Vente
          </button>
          <button mat-menu-item (click)="ouvrirPopupReservation(vehicule)">
            <mat-icon>event</mat-icon> R√©servation
          </button>
        </mat-menu>
      </td>
    </ng-container>

    <!-- ‚úÖ Lignes -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
  <div *ngIf="vehiculesFiltres.length === 0 && searchQuery">
    <p style="text-align:center; color: #999;">‚ùå Aucun v√©hicule trouv√© pour cette recherche.</p>
  </div>
</div>
</div>